{% extends "base.html" %}
{% load static %}
{% block title %}Lista de Tokens - Tokens App{% endblock %}

{% block content %}

{% if sucesso %}
<div class="alert alert-success" role="alert">
    {{sucesso}}
</div>
{% endif %}

<style>
    .container {
        min-height: 85vh;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .head_left {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        width: 100%;
        flex-wrap: wrap;
    }

    .logo-container {
        display: flex;
        align-items: center;
    }

    .head_left img.logo-img {
        height: 60px;
        max-width: 100%;
        object-fit: contain;
    }

    .buttons-container {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: flex-end;
    }

    .head_left a.btn {
        font-size: 1rem;
        padding: 10px 16px;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.3s ease-in-out;
        white-space: nowrap;
        margin: 2px 0;
    }

    .head_left a.btn:hover {
        transform: scale(1.03);
    }

    #searchInput {
        font-size: 1rem;
        padding: 10px;
    }

    .table-container {
        max-height: 70vh;
        overflow-y: auto;
        border: 1px solid #dee2e6;
    }

    .table thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 2;
        text-align: center;
    }

    .table th, .table td {
        vertical-align: middle;
        text-align: center;
    }

    #select_funcao {
        padding: 6px;
        font-size: 0.95rem;
        border-radius: 4px;
        border: 1px solid #ccc;
        width: 100%;
    }
</style>

<div class="container">
    <div class="head_left">
        <!-- Logo à esquerda -->
        <div class="logo-container">
            <img src="{% static 'tokens_app/images/logo.png' %}" alt="Logo Tokens" class="logo-img">
        </div>
        
        <!-- Botões à direita -->
        <div class="buttons-container">
            <a href="{% url 'home' %}" class="btn btn-secondary">Voltar</a>
            <a href="{% url 'novo_token' %}" class="btn btn-primary">Cadastrar Token</a>
            <a href="{% url 'lista_tokens' %}" name="recarregar_lista" class="btn btn-info">Atualizar lista</a>
            <a href="{% url 'exportar_planilha' %}" name="exportar_planilha" class="btn btn-success">Exportar planilha</a>
            <a href="{% url 'logout' %}" name="logout" class="btn btn-danger">Sair</a>
        </div>
    </div>

    <!-- Campo de busca com botão limpar alinhado -->
    <div class="input-group mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Pesquisar por nome, CPF ou setor...">
        <button class="btn btn-outline-secondary" type="button"
            onclick="document.getElementById('searchInput').value=''; document.getElementById('searchInput').dispatchEvent(new Event('input'));">
            Limpar
        </button>
    </div>

    <div class="table-container">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Serial</th>
                    <th>Nome</th>
                    <th>CPF</th>
                    <th>
                        <select name="select_funcao" id="select_funcao" onchange="window.location.href='/lista_tokens/' + this.value">
                            <option>Função</option>
                            {% for funcao in funcoes %}
                                <option value="{{ funcao }}">{{ funcao }}</option>
                            {% endfor %}
                        </select>
                    </th>
                    <th>Data de solicitação</th>
                    <th>Data de entrega</th>
                    <th>Criado por</th>
                    <th>Última modificação por</th>
                    <th>Observação</th>
                </tr>
            </thead>
            <tbody>
                {% for token in tokens %}
                    {% if token.token_ativo %}
                        <div id="meuModal" class="modal-custom">
                            <div id="modal-{{ token.id }}" class="modal-content-custom">
                                <span class="close-modal" data-modal-id="modal-{{ token.id }}">&times;</span>
                                <h5>Observação</h5>
                                <p>{{ token.observacao }}</p>
                            </div>
                        </div>
                        <tr>
                            <td>{{ token.serial }}</td>
                            <td><a href="{% url 'atualizar_token' token.id %}" style="text-decoration: none;">{{ token }}</a></td>
                            <td id="cpf">{{ token.cpf_responsavel }}</td>
                            <td>{{ token.funcao_responsavel }}</td>
                            <td>{{ token.data_solicitacao }}</td>
                            <td>{{ token.data_entrega }}</td>
                            <td>{{ token.criador }}</td>
                            <td>{{ token.modificador }}</td>
                            {% if token.observacao != "" %}
                                {% if token.observacao|length > 30 %}
                                    <td>Entre na edição para ver a observação.</td>
                                {% else %}
                                    <td>{{ token.observacao }}</td>
                                {% endif %}
                            {% else %}
                                <td><b>Nenhuma observação</b></td>
                            {% endif %}
                        </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if not sucesso %}
<span id="naoSucesso"></span>
{% endif %}

<script>
    if (document.getElementById("naoSucesso")) {
        document.body.style.marginTop = "50px";
    }

    const modal = document.getElementById("meuModal");
    var btns = document.getElementsByClassName("abrirModal");
    const fechar = document.querySelector(".close-modal");

    for (btn of btns) {
        btn.onclick = () => {
            modal.classList.add("ativo");
        }
    }

    fechar.onclick = () => {
        modal.classList.remove("ativo");
    }

    window.onclick = (event) => {
        if (event.target === modal) {
            modal.classList.remove("ativo");
        }
    }

    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            let found = false;

            cells.forEach(cell => {
                if (cell.textContent.toLowerCase().includes(filter)) {
                    found = true;
                }
            });

            row.style.display = found ? '' : 'none';
        });
    });

    window.onload = () => {
        document.getElementById('searchInput').focus();
    };
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
    $(document).ready(function () {
        $('#cpf').mask('000.000.000-00');
        $('#telefone').mask('(00) 00000-0000');
    });
</script>

{% endblock %}